<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Room Booking ‚Äì Company Trip</title>
<style>
  :root{ --accent:#c20000; --muted:#6b6b6b; --card:#fff; }
  body{ font-family:"Segoe UI",Roboto,Arial,sans-serif; background:#f3f4f6; margin:0; color:#222; }
  header{ display:flex; align-items:center; justify-content:center; gap:16px; background:white; padding:16px 20px; box-shadow:0 1px 4px rgba(0,0,0,0.06); position:sticky; top:0; z-index:10; }
  header .left{ position:absolute; left:20px; }
  header img{ height:48px; display:block; }
  header h1{ margin:0; color:var(--accent); font-size:22px; font-weight:700; }

  .controls{ max-width:1100px; margin:18px auto 0; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:0 16px; }
  .stats{ font-size:15px; color:var(--muted); }
  button.primary{ background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  button.ghost{ background:transparent; border:1px solid #ddd; padding:7px 10px; border-radius:8px; cursor:pointer; }

  .sections-wrap{ max-width:1100px; margin:18px auto 90px; display:grid; grid-template-columns:repeat(3,1fr); gap:18px; padding:0 16px; box-sizing:border-box; }
  .section{ background:white; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
  .section .header{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; }
  .section h2{ margin:0; color:var(--accent); font-size:16px; }
  .section .controls-inline{ display:flex; gap:8px; align-items:center; }

  .room-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); gap:12px; }
  .room-card{ background:var(--card); border-radius:10px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); text-align:center; border:2px solid transparent; cursor:pointer; transition:transform .12s ease,border-color .12s; }
  .room-card:hover{ transform:translateY(-4px); border-color:#e6e6e6; }
  .room-card.locked{ opacity:0.75; cursor:not-allowed; border-color:#f4cccc; background:#fff6f6; }
  .room-icon{ font-size:34px; margin-bottom:6px; }
  .room-name{ font-weight:700; margin-bottom:6px; font-size:14px; color:#111; }
  .room-occupants{ font-size:13px; color:var(--muted); min-height:28px; line-height:1.2; }

  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:50; padding:20px; }
  .modal.open{ display:flex; }
  .modal-panel{ width:420px; max-width:92%; background:white; border-radius:12px; padding:18px; box-shadow:0 12px 36px rgba(0,0,0,0.18); text-align:left; }
  .modal-panel h3{ margin:0 0 12px; font-size:18px; color:#222; text-align:center; }
  .modal-panel .sub{ font-size:13px; color:var(--muted); text-align:center; margin-bottom:12px; }
  .input{ width:100%; box-sizing:border-box; padding:10px 12px; border-radius:8px; border:1px solid #dcdcdc; font-size:15px; margin-bottom:14px; outline:none; }
  .row{ display:flex; gap:10px; }
  .row .btn{ flex:1; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .btn.register{ background:var(--accent); color:white; }
  .btn.close{ background:#f0f0f0; color:#333; }

  .stats-page{ display:none; max-width:1100px; margin:40px auto; background:white; border-radius:12px; padding:20px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
  .stats-page table{ width:100%; border-collapse:collapse; margin-top:16px; }
  .stats-page th, .stats-page td{ border:1px solid #ddd; padding:8px; text-align:left; }
  .stats-page th{ background:#f8f8f8; }
  .back-btn{ margin-top:20px; background:#333; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
  @media (max-width:980px){ .sections-wrap{ grid-template-columns:1fr; } }
</style>
</head>
<body>

<header>
  <div class="left"><img src="c054929f-e7b4-4cf9-9ee4-0eb99611c227.png" alt="Logo"></div>
  <h1>Room Booking ‚Äì Company Trip</h1>
</header>

<div class="controls" id="main-controls">
  <div class="stats"><span id="totalInfo">Loading...</span></div>
  <div>
    <button class="ghost" id="exportCsvBtn">Export CSV</button>
    <button class="primary" id="openAdmin">Admin</button>
  </div>
</div>

<div class="sections-wrap" id="main-page">
  <div class="section">
    <div class="header"><h2>Single Rooms</h2><div class="controls-inline">
      <button class="ghost admin-only" id="single-remove">‚àí Remove Room</button>
      <button class="ghost" id="single-add">Ôºã Add Room</button>
    </div></div>
    <div class="room-grid" id="grid-single"></div>
  </div>
  <div class="section">
    <div class="header"><h2>Double Rooms</h2><div class="controls-inline">
      <button class="ghost admin-only" id="double-remove">‚àí Remove Room</button>
      <button class="ghost" id="double-add">Ôºã Add Room</button>
    </div></div>
    <div class="room-grid" id="grid-double"></div>
  </div>
  <div class="section">
    <div class="header"><h2>Twin Rooms (two separate single beds)</h2><div class="controls-inline">
      <button class="ghost admin-only" id="twin-remove">‚àí Remove Room</button>
      <button class="ghost" id="twin-add">Ôºã Add Room</button>
    </div></div>
    <div class="room-grid" id="grid-twin"></div>
  </div>
</div>

<div class="stats-page" id="stats-page">
  <h2>üìä Room Statistics</h2>
  <div id="stats-summary"></div>
  <table id="stats-table">
    <thead><tr><th>Room</th><th>Type</th><th>Capacity</th><th>Occupant</th><th>Time</th></tr></thead><tbody></tbody>
  </table>
  <button class="back-btn" onclick="backToMain()">‚Üê Back</button>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-panel">
    <h3 id="modalTitle"></h3>
    <div class="sub" id="modalSub"></div>
    <div id="occupantList"></div>
    <input id="nameInput" class="input" placeholder="Enter your name" />
    <div class="row"><button class="btn register" id="registerBtn">Register</button><button class="btn close" id="closeBtn">Close</button></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ==================== Firebase Setup ====================
const firebaseConfig = {
  apiKey: "AIzaSyDkLZiqaOlsdhVmDABQQjkIk09XRGsXJFs",
  authDomain: "room-booking-app-c7db8.firebaseapp.com",
  databaseURL: "https://room-booking-app-c7db8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "room-booking-app-c7db8",
  storageBucket: "room-booking-app-c7db8.firebasestorage.app",
  messagingSenderId: "343921663087",
  appId: "1:343921663087:web:2413b98b2c2bf452f2c19a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
// =========================================================

const ADMIN_PASS = "0977549979";
let rooms = [];
let isAdmin = false;
let currentRoomIndex = null;

// === Initialization flag (safe setup) ===
async function initializeDatabaseOnce() {
  const flag = await db.ref("initialized").get();
  if (!flag.exists() || !flag.val()) {
    const defaults = [];
    for (let i = 1; i <= 5; i++) defaults.push({ name: `Single Room ${i}`, type: "single", max: 1, people: [] });
    for (let i = 1; i <= 5; i++) defaults.push({ name: `Double Room ${i}`, type: "double", max: 2, people: [] });
    for (let i = 1; i <= 5; i++) defaults.push({ name: `Twin Room ${i}`, type: "twin", max: 2, people: [] });
    await db.ref("rooms").set(defaults);
    await db.ref("initialized").set(true);
    console.log("‚úÖ Database initialized for the first time");
  }
}

// === Realtime listener ===
db.ref("rooms").on("value", snap => {
  const val = snap.val();
  if (!val) return;
  rooms = Array.isArray(val) ? val : Object.values(val);
  render();
});
initializeDatabaseOnce();

// === Helper functions ===
function nowString() { return new Date().toLocaleString(); }
function saveRooms() { db.ref("rooms").set(rooms); }

// === Render UI ===
const gridSingle = document.getElementById("grid-single");
const gridDouble = document.getElementById("grid-double");
const gridTwin = document.getElementById("grid-twin");
const totalInfo = document.getElementById("totalInfo");

function render() {
  gridSingle.innerHTML = gridDouble.innerHTML = gridTwin.innerHTML = "";
  rooms.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "room-card" + (r.people.length >= r.max ? " locked" : "");
    div.innerHTML = `
      <div class="room-icon">üö™</div>
      <div class="room-name">${r.name}</div>
      <div class="room-occupants">${r.people.length ? r.people.map(p => p.name).join("<br>") : "<i>No occupants</i>"}</div>
      <div style="font-size:12px;color:#777">${r.people.length}/${r.max}</div>`;
    div.onclick = () => {
      if (r.people.length < r.max) openModal(i);
      else alert("This room is full.");
    };
    if (r.type === "single") gridSingle.appendChild(div);
    else if (r.type === "double") gridDouble.appendChild(div);
    else gridTwin.appendChild(div);
  });
  const totalPeople = rooms.reduce((s, r) => s + r.people.length, 0);
  totalInfo.textContent = `Total: ${rooms.length} rooms ‚Ä¢ ${totalPeople} people`;
  document.querySelectorAll(".admin-only").forEach(el => el.style.display = isAdmin ? "inline-block" : "none");
}

// === Add / Remove Rooms ===
function addRoom(type) {
  const base = type === "single" ? "Single Room" : type === "double" ? "Double Room" : "Twin Room";
  const count = rooms.filter(r => r.type === type).length;
  const name = prompt("Room name:", `${base} ${count + 1}`);
  if (!name) return;
  const max = type === "single" ? 1 : 2;
  rooms.push({ name, type, max, people: [] });
  saveRooms();
}
function removeRoom(type) {
  if (!isAdmin) return alert("Admin only.");
  const list = rooms.filter(r => r.type === type);
  if (!list.length) return alert("No room to remove.");
  const lastIndex = rooms.lastIndexOf(list[list.length - 1]);
  if (confirm(`Delete ${list[list.length - 1].name}?`)) {
    rooms.splice(lastIndex, 1);
    saveRooms();
  }
}
document.getElementById("single-add").onclick = () => addRoom("single");
document.getElementById("double-add").onclick = () => addRoom("double");
document.getElementById("twin-add").onclick = () => addRoom("twin");
document.getElementById("single-remove").onclick = () => removeRoom("single");
document.getElementById("double-remove").onclick = () => removeRoom("double");
document.getElementById("twin-remove").onclick = () => removeRoom("twin");

// === Modal ===
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const occupantList = document.getElementById("occupantList");
const nameInput = document.getElementById("nameInput");

function openModal(i) {
  currentRoomIndex = i;
  const r = rooms[i];
  modalTitle.textContent = r.name;
  renderOccupants(r);
  modal.classList.add("open");
}
function closeModal() { modal.classList.remove("open"); }
function renderOccupants(r) {
  occupantList.innerHTML = "";
  if (!r.people.length) return occupantList.innerHTML = "<div>No occupants yet</div>";
  r.people.forEach((p, j) => {
    const item = document.createElement("div");
    item.className = "occupant-item";
    item.innerHTML = `${p.name} <small>(${p.time})</small>`;
    const btn = document.createElement("button");
    btn.textContent = "Remove";
    btn.style.display = isAdmin ? "inline" : "none";
    btn.onclick = () => { if (confirm(`Remove ${p.name}?`)) { r.people.splice(j, 1); saveRooms(); } };
    item.appendChild(btn);
    occupantList.appendChild(item);
  });
}
document.getElementById("registerBtn").onclick = () => {
  const name = nameInput.value.trim();
  if (!name) return alert("Enter your name");
  const r = rooms[currentRoomIndex];
  if (r.people.length >= r.max) return alert("Room full");
  r.people.push({ name, time: nowString() });
  saveRooms();
  closeModal();
};
document.getElementById("closeBtn").onclick = closeModal;
modal.onclick = e => { if (e.target === modal) closeModal(); };

// === Admin ===
document.getElementById("openAdmin").onclick = () => {
  const pass = prompt("Enter admin password:");
  if (pass === ADMIN_PASS) { isAdmin = true; alert("Admin logged in"); render(); showAdminMenu(); }
  else alert("Wrong password");
};
document.getElementById("exportCsvBtn").onclick = () => { if (!isAdmin) return alert("Admin only"); exportCSV(); };

function showAdminMenu() {
  const choice = prompt(`Admin Panel
1 - Statistics
2 - Delete Person
3 - Delete Room
4 - Reset All Data
5 - Export CSV
6 - Open Stats Page
7 - Reinitialize Database`);
  if (!choice) return;
  switch (choice.trim()) {
    case "1": adminStats(); break;
    case "2": adminDelPerson(); break;
    case "3": adminDelRoom(); break;
    case "4": adminReset(); break;
    case "5": exportCSV(); break;
    case "6": openStatsPage(); break;
    case "7": reinitializeDatabase(); break;
  }
}

function adminStats() {
  const c = { single: 0, double: 0, twin: 0 }, p = { single: 0, double: 0, twin: 0 };
  rooms.forEach(r => { c[r.type]++; p[r.type] += r.people.length; });
  alert(`Single: ${c.single} rooms, ${p.single} people
Double: ${c.double} rooms,
